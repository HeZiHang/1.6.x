<?php
session_start();

ini_set('display_errors', 1);
ini_set('error_reporting', E_ALL);
ini_set('error_prepend_string',"<p class='text-error'>");
ini_set('error_append_string',"</p>");
if(!isset($_SESSION["uid"])){header("location:miniadm.logon.php");}
if(isset($_GET["verbose"])){$GLOBALS["VERBOSE"]=true;}

include_once(dirname(__FILE__)."/ressources/class.templates.inc");
include_once(dirname(__FILE__)."/ressources/class.users.menus.inc");
include_once(dirname(__FILE__)."/ressources/class.miniadm.inc");
include_once(dirname(__FILE__)."/ressources/class.user.inc");
include_once(dirname(__FILE__)."/ressources/class.squid.inc");
include_once(dirname(__FILE__)."/ressources/class.squid.reverse.inc");
$PRIV=GetPrivs();if(!$PRIV){header("location:miniadm.index.php");die();}

if(isset($_GET["section"])){section();exit;}
if(isset($_GET["group-search"])){group_search();exit;}
if(isset($_GET["js-group"])){group_js();exit;}
if(isset($_GET["group-section"])){group_section();exit;}
if(isset($_GET["group-popup"])){group_popup();exit;}
if(isset($_POST["editgroupid"])){group_save();exit;}
if(isset($_GET["delete-group-js"])){group_delete_js();exit;}
if(isset($_GET["choose-group-js"])){group_choose_js();exit;}
if(isset($_POST["choose-group"])){group_choose();exit;}


if(isset($_POST["delete-group"])){group_delete();exit;}
if(isset($_GET["items-section"])){items_section();exit;}
if(isset($_GET["items-search"])){items_search();exit;}
if(isset($_GET["js-item"])){js_item();exit;}
if(isset($_GET["item-popup"])){item_popup();exit;}
if(isset($_POST["edititem"])){item_save();exit;}
if(isset($_GET["delete-item-js"])){item_delete_js();exit;}
if(isset($_POST["delete-item"])){item_delete();exit;}


js();


function GetPrivs(){
	$NGNIX_PRIVS=$_SESSION["NGNIX_PRIVS"];
	$users=new usersMenus();
	if($users->AsSystemWebMaster){return true;}
	if($users->AsSquidAdministrator){return true;}
	if(count($_SESSION["NGNIX_PRIVS"])>0){return true;}
	return false;

}



function js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$title=$tpl->javascript_parse_text("{anti_exploits}::{groups}");
	echo "YahooWin4(800,'$page?section=yes&servername={$_GET["servername"]}','{$_GET["servername"]}::$title')";
}
function group_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["ID"];
	if($ID==0){
	$title="{anti_exploits}::{new_group}::{$_GET["servername"]}";
	}else{
		$q=new mysql_squid_builder();
		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='{$_GET["ID"]}'"));
		
		$title="{anti_exploits}::{group2}:{$ligne["groupname"]}";
	}
	$title=$tpl->javascript_parse_text($title);
	echo "YahooWin5(920,'$page?group-section=yes&servername={$_GET["servername"]}&ID=$ID','$title')";	
	
}
function js_item(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='{$_GET["ID"]}'"));
	$ID=$_GET["ID"];
	if($ID==0){
		$title="{anti_exploits}::{new_item}::{$ligne["groupname"]}::{$_GET["servername"]}";
	}else{
		$title="{anti_exploits}::{$ligne["groupname"]}::{$_GET["servername"]}";
	}
	$title=$tpl->javascript_parse_text($title);
	echo "YahooWin6(550,'$page?item-popup=yes&servername={$_GET["servername"]}&ID=$ID&groupid={$_GET["groupid"]}','$title')";
		
	
}

function item_delete_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["delete-item-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_items WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{delete}");
	$t=time();
	$ligne["pattern"]=str_replace("'", "`", $ligne["pattern"]);
	echo "
		
	var xdelete$t= function (obj) {
		var results=obj.responseText;
		if(results.length>3){alert(results);}
		ExecuteByClassName('SearchFunction');
	}
	
	function delete$t(){
		if(!confirm('$delete \"{$ligne["pattern"]}\" ?')){return;}
		var XHR = new XHRConnection();
		XHR.appendData('delete-item','$ID');
		XHR.sendAndLoad('$page', 'POST',xdelete$t);
	}
		
		
	delete$t();";
	
	
	}
function item_delete(){
	$q=new mysql_squid_builder();
	$q->QUERY_SQL("DELETE FROM nginx_exploits_items WHERE ID='{$_POST["delete-item"]}'");
	if(!$q->ok){echo $q->mysql_error;return;}
}

function group_delete_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["delete-group-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{delete}");
	$t=time();
	echo "
			
	var xdelete$t= function (obj) {
		var results=obj.responseText;
		if(results.length>3){alert(results);}
		ExecuteByClassName('SearchFunction');
	}
	
		function delete$t(){
			if(!confirm('$delete {$ligne["groupname"]} ?')){return;}
			var XHR = new XHRConnection();
			XHR.appendData('delete-group','$ID');
			XHR.sendAndLoad('$page', 'POST',xdelete$t);	
		}
			
			
	delete$t();";
	
	
}
function group_choose_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["choose-group-js"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{choose}");
	$t=time();
	echo "
		
	var xdelete$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);}
	ExecuteByClassName('SearchFunction');
	}
	
	function delete$t(){
	if(!confirm('$delete {$ligne["groupname"]} / {$_GET["servername"]}')){return;}
	var XHR = new XHRConnection();
	XHR.appendData('choose-group','$ID');
	XHR.appendData('servername','{$_GET["servername"]}');
	XHR.sendAndLoad('$page', 'POST',xdelete$t);
	}
		
		
	delete$t();";
}

function group_choose(){
	$zmd5=md5("{$_POST["choose-group"]}{$_POST["servername"]}");
	$sql="INSERT IGNORE INTO nginx_exploits (zmd5,groupid,servername) VALUES('$zmd5','{$_POST["choose-group"]}','{$_POST["servername"]}')";
	$q=new mysql_squid_builder();
	$q->QUERY_SQL($sql);
	if(!$q->ok){echo $q->mysql_error;return;}
}

function group_delete(){
	$q=new mysql_squid_builder();
	$q->QUERY_SQL("DELETE FROM nginx_exploits_items WHERE groupid={$_POST["delete-group"]}");
	if(!$q->ok){echo $q->mysql_error;return;}
	$q->QUERY_SQL("DELETE FROM nginx_exploits_groups WHERE ID={$_POST["delete-group"]}");
	if(!$q->ok){echo $q->mysql_error;return;}
	$q->QUERY_SQL("DELETE FROM nginx_exploits WHERE groupid={$_POST["delete-group"]}");
	if(!$q->ok){echo $q->mysql_error;return;}	
	
}

function group_section(){
	
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["ID"];
	
	$array["group"]="{new_group}";
	
	if($ID>0){
		$array["group"]="{group}";
		$array["items"]="{items}";
		
	}
	
	
	$fontsize=18;
	while (list ($num, $ligne) = each ($array) ){
	
		if($num=="group"){
			$tab[]= $tpl->_ENGINE_parse_body("<li><a href=\"$page?group-popup=yes&ID=$ID&servername={$_GET["servername"]}\" style='font-size:{$fontsize}px'><span>$ligne</span></a></li>\n");
			continue;
		}
		if($num=="items"){
			$tab[]= $tpl->_ENGINE_parse_body("<li><a href=\"$page?items-section=yes&groupid=$ID&servername={$_GET["servername"]}\" style='font-size:{$fontsize}px'><span>$ligne</span></a></li>\n");
			continue;
		}
	
		$tab[]="<li style='font-size:{$fontsize}px'><a href=\"$page?$num=yes&servername=$servername_enc\"><span >$ligne</span></a></li>\n";
			
	}
	
	echo build_artica_tabs($tab, "main_nginx_exploit_group_section");	
	
}

function item_popup(){
	$ID=$_GET["ID"];
	$q=new mysql_squid_builder();
	$title="{new_group}";
	$bt="{add}";
	$q=new mysql_squid_builder();	
	
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='{$_GET["groupid"]}'"));
	$groupname=$ligne["groupname"];	
	$ligne["enabled"]=1;
	
	if($ID>0){
	
		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_items WHERE ID='$ID'"));
		$bt="{apply}";
		$title="$groupname::{{$ligne["token"]}}";
	
	}	
	
	$array["http_user_agent"]="{http_user_agent}";
	$array["query_string"]="{query_string}";
	
	$boot=new boostrap_form();
	$boot->set_hidden("edititem", $ID);
	$boot->set_hidden("groupid", $_GET["groupid"]);
	$boot->set_formtitle($title);
	$boot->set_list("token", "{token}", $array,$ligne["token"]);
	$boot->set_textarea("pattern", "{pattern}", $ligne["pattern"],array("ENCODE"=>true));
	$boot->set_checkbox("reverse", "{reverse}", $ligne["reverse"]);
	$boot->set_checkbox("enabled", "{enabled}", $ligne["enabled"]);
	$boot->set_button($bt);
	if($ID==0){$boot->set_CloseYahoo("YahooWin6");}
	$boot->set_RefreshSearchs();
	echo $boot->Compile();
	
}
function item_save(){
	$q=new mysql_squid_builder();
	
	if(!$q->FIELD_EXISTS("nginx_exploits_items", "reverse")){
		$q->QUERY_SQL("ALTER TABLE `nginx_exploits_items` ADD `reverse` smallint(1) NOT NULL DEFAULT 0, ADD INDEX ( `reverse`)");
	}
	
	$ID=$_POST["edititem"];
	$_POST["pattern"]=mysql_escape_string2(url_decode_special_tool($_POST["pattern"]));
	if($ID==0){
		$sql="INSERT IGNORE INTO nginx_exploits_groups (`groupname`)
		VALUES ('{$_POST["groupname"]}')";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;return;}
		$ID=$q->last_id;
		$sql="INSERT IGNORE INTO nginx_exploits_items (`groupid`,`enabled`,`pattern`,`token`,`reverse`) VALUES
				('{$_POST["groupid"]}','{$_POST["enabled"]}','{$_POST["pattern"]}','{$_POST["token"]}','{$_POST["reverse"]}')";
			$q->QUERY_SQL($sql);
			if(!$q->ok){echo $q->mysql_error;return;}
		return;
		}
	$q->QUERY_SQL("UPDATE nginx_exploits_items SET `pattern`='{$_POST["pattern"]}',`token`='{$_POST["token"]}',`reverse`='{$_POST["reverse"]}',
	`enabled`='{$_POST["enabled"]}' WHERE ID=$ID");
	if(!$q->ok){echo $q->mysql_error;return;}
}

function group_popup(){
	$ID=$_GET["ID"];
	$q=new mysql_squid_builder();
	$title="{new_group}";
	$bt="{add}";
	$q=new mysql_squid_builder();
	
	if(!$q->TABLE_EXISTS("nginx_exploits_groups")){
		$sql="CREATE TABLE IF NOT EXISTS `nginx_exploits_groups` (
			  `ID` INT NOT NULL AUTO_INCREMENT,
			  `groupname` CHAR(255)  NOT NULL,
			  PRIMARY KEY (`ID`),
			  KEY `groupname` (`groupname`)
			)  ENGINE = MYISAM;";
		if(!$q->QUERY_SQL($sql)){echo $q->mysql_error_html();}
	}
	
	$boot=new boostrap_form();
	$sock=new sockets();
	

	if($ID>0){
		$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
		$bt="{apply}";
		$title="{$ligne["groupname"]}";
	
	}
	

	$boot->set_hidden("editgroupid", $ID);
	$boot->set_hidden("servername", $_GET["servername"]);
	$boot->set_formtitle($title);
	$boot->set_field("groupname", "{groupname}", $ligne["groupname"]);
	
	if($ID==0){
		$boot->set_checkbox("addef", "{add_defaults}", 0);
	}
	$boot->set_button($bt);
	if($ID==0){$boot->set_CloseYahoo("YahooWin5");}
	$boot->set_RefreshSearchs();
	echo $boot->Compile();
}

function group_save(){
	$q=new mysql_squid_builder();
	$ID=$_POST["editgroupid"];
	if($ID==0){
		$sql="INSERT IGNORE INTO nginx_exploits_groups (`groupname`) 
		VALUES ('{$_POST["groupname"]}')";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;return;}
		$ID=$q->last_id;
		if($_POST["servername"]<>null){
			$zmd5=md5("$ID{$_POST["servername"]}");
			$sql="INSERT IGNORE INTO nginx_exploits (`zmd5`,`groupid`,`servername`)
			VALUES ('$zmd5',$ID,'{$_POST["servername"]}')";
			$q->QUERY_SQL($sql);
			if(!$q->ok){echo $q->mysql_error;return;}
		}
		
		if($_POST["addef"]==1){
			group_defaults($ID);
		}
		
	return;
	}

	$q->QUERY_SQL("UPDATE nginx_exploits_groups SET `groupname`='{$_POST["groupname"]}',
	`enabled`='{$_POST["enabled"]}' WHERE ID=$ID");
	if(!$q->ok){echo $q->mysql_error;return;}
}

function group_defaults($ID){
	$f[]="union.*select.*\(";
	$f[]="union.*all.*select.*";
	$f[]="concat.*\(";
	$f[]="[a-zA-Z0-9_]=http://";
	$f[]="[a-zA-Z0-9_]=(\.\.//?)+";
	$f[]="[a-zA-Z0-9_]=/([a-z0-9_.]//?)+";
	$f[]="(<|%3C).*script.*(>|%3E)";
	$f[]="GLOBALS(=|\[|\%[0-9A-Z]{0,2)";
	$f[]="_REQUEST(=|\[|\%[0-9A-Z]{0,2)";
	$f[]="proc/self/environ";
	$f[]="mosConfig_[a-zA-Z_]{1,21(=|\%3D)";
	$f[]="base64_(en|de)code\(.*\)";
	$f[]="\b(ultram|unicauca|valium|viagra|vicodin|xanax|ypxaieo)\b";
	$f[]="\b(erections|hoodia|huronriveracres|impotence|levitra|libido)\b";
	$f[]="\b(ambien|blue\spill|cialis|cocaine|ejaculation|erectile)\b";
	$f[]="\b(lipitor|phentermin|pro[sz]ac|sandyauer|tramadol|troyhamby)\b";
	
	
	
	
	$prefix="INSERT IGNORE INTO nginx_exploits_items (`groupid`,`enabled`,`pattern`,`token`) VALUES";
	while (list ($head, $pattern) = each ($f) ){
		$n[]="($ID,1,'".mysql_escape_string2($pattern)."','query_string')";
	
	}
	
	
	$f=array();
	$f[]="Wget";
	$f[]="Indy Library";
	$f[]="libwww-perl";
	$f[]="GetRight";
	$f[]="GetWeb!";
	$f[]="Go!Zilla";
	$f[]="Download Demon";
	$f[]="Go-Ahead-Got-It";
	$f[]="TurnitinBot";
	$f[]="GrabNet";
	$f[]="Nmap";
	$f[]="(SBIder/Nutch-1.0-dev|Purebot/1.1|spbot/2.0.2|Toata|Python-urllib)";
	
	
	$q=new mysql_squid_builder();
	
	if(!$q->TABLE_EXISTS("nginx_exploits_items")){
		$sql="CREATE TABLE IF NOT EXISTS `nginx_exploits_items` (
			  `ID` INT NOT NULL AUTO_INCREMENT,
			  `groupid` INT NOT NULL DEFAULT '0',
			  `enabled` smallint(1)  NOT NULL,
			  `pattern` TEXT,
			  `token` CHAR(20)  NOT NULL,
			  PRIMARY KEY (`ID`),
			  KEY `groupid` (`groupid`),
			  KEY `enabled` (`enabled`),
			  KEY `token` (`token`)
			)  ENGINE = MYISAM;";
		$q->QUERY_SQL($sql);
		if(!$q->ok){echo $q->mysql_error;}
	}
	
	
	while (list ($head, $pattern) = each ($f) ){
		$n[]="($ID,1,'".mysql_escape_string2($pattern)."','http_user_agent')";
		
	}
	
	$q->QUERY_SQL($prefix.@implode(",", $n));
	if(!$q->ok){echo $q->mysql_error;}
}


function section(){
	$boot=new boostrap_form();
	$tpl=new templates();
	$page=CurrentPageName();
	$error=null;
	$EXPLAIN["BUTTONS"][]=$tpl->_ENGINE_parse_body(button("{new_group}", "Loadjs('$page?js-group=yes&ID=0&servername={$_GET["servername"]}')"));
	echo $boot->SearchFormGen("groupname","group-search","&servername={$_GET["servername"]}",$EXPLAIN);
}

function items_section(){
	$boot=new boostrap_form();
	$tpl=new templates();
	$page=CurrentPageName();
	$error=null;
	$EXPLAIN["BUTTONS"][]=$tpl->_ENGINE_parse_body(button("{new_item}", "Loadjs('$page?js-item=yes&ID=0&groupid={$_GET["groupid"]}&servername={$_GET["servername"]}')"));
	echo $boot->SearchFormGen("pattern","items-search","&servername={$_GET["servername"]}&groupid={$_GET["groupid"]}",$EXPLAIN);	
}

function group_search(){
	$page=CurrentPageName();
	$boot=new boostrap_form();
	$tpl=new templates();
	$searchstring=string_to_flexquery("group-search");
	$ORDER=$boot->TableOrder(array("groupname"=>"ASC"));
	$limitSql="LIMIT 0,150";
	$sql="SELECT *  FROM nginx_exploits_groups WHERE 1 $searchstring  ORDER BY $ORDER $limitSql";	
	$q=new mysql_squid_builder();
	$results = $q->QUERY_SQL($sql);
	$sock=new sockets();
	
	
	if(!$q->ok){echo $q->mysql_error_html();}
	
	while ($ligne = mysql_fetch_assoc($results)) {
		$linkipaddr=$boot->trswitch("Loadjs('$page?js-group=yes&ID={$ligne["ID"]}&servername={$_GET["servername"]}')");
		$delete=imgsimple("delete-24.png",null,"Loadjs('$page?delete-group-js={$ligne["ID"]}&ID={$ligne["ID"]}')");
		$choose=imgsimple("arrow-right-24.png",null,"Loadjs('$page?choose-group-js={$ligne["ID"]}&ID={$ligne["ID"]}&servername={$_GET["servername"]}')");
		$ligne2=mysql_fetch_array($q->QUERY_SQL("SELECT COUNT(*) as tcount FROM nginx_exploits_items WHERE groupid='{$ligne["ID"]}'"));
		
		$tr[]="
		<tr id='{$ligne["ID"]}'>
		<td $linkipaddr width='90%' nowrap><i class='icon-lock'></i> {$ligne["groupname"]}</a></td>
		<td $linkipaddr width='24px' nowrap>{$ligne2["tcount"]}</a></td>
		<td width='24px' nowrap>$choose</td>
		<td width='24px' nowrap>$delete</td>
	</tr>";
	
	
	}
	
	$html=$boot->TableCompile(
	array("groupname"=>"{group}","items:no"=>"{items}","choose:no"=>"{choose}",
	"delete:no"=>"{delete}",
	
		),$tr
	);
	
	echo $tpl->_ENGINE_parse_body($html);	
}
function items_search(){
	$page=CurrentPageName();
	$boot=new boostrap_form();
	$tpl=new templates();
	$searchstring=string_to_flexquery("items-search");
	$ORDER=$boot->TableOrder(array("token"=>"ASC"));
	$limitSql="LIMIT 0,150";
	$sql="SELECT *  FROM nginx_exploits_items WHERE groupid={$_GET["groupid"]} $searchstring  ORDER BY $ORDER $limitSql";
	$q=new mysql_squid_builder();
	$results = $q->QUERY_SQL($sql);
	$sock=new sockets();
	$not=$tpl->_ENGINE_parse_body("{is_not}");
	
	if(!$q->ok){echo $q->mysql_error_html();}
	
	while ($ligne = mysql_fetch_assoc($results)) {
		$reverse=null;
		if($ligne["reverse"]==1){$reverse="<strong>$not</strong>&nbsp;";}
		$linkipaddr=$boot->trswitch("Loadjs('$page?js-item=yes&ID={$ligne["ID"]}&groupid={$ligne["groupid"]}&servername={$_GET["servername"]}')");
		$ligne["token"]=$tpl->_ENGINE_parse_body("{{$ligne["token"]}}");
	$delete=imgsimple("delete-24.png",null,"Loadjs('$page?delete-item-js={$ligne["ID"]}&ID={$ligne["ID"]}')");
	$tr[]="
	<tr id='{$ligne["ID"]}'>
	<td $linkipaddr width='30%' nowrap><i class='icon-list-alt'></i> {$ligne["token"]}</a></td>
	<td $linkipaddr width='70%' nowrap><i class='icon-list-alt'></i> $reverse{$ligne["pattern"]}</a></td>
	<td style='text-align:center' width='24px' nowrap>$delete</td>
	</tr>";
	
	
	}
	
	$html=$boot->TableCompile(
			array(
			"token"=>"{token}",
			"pattern"=>"{pattern}",
			"delete"=>"{delete}",
	
		),$tr
	);
	
	echo $tpl->_ENGINE_parse_body($html);	
	
}
