<?php
session_start();

ini_set('display_errors', 1);
ini_set('error_reporting', E_ALL);
ini_set('error_prepend_string',"<p class='text-error'>");
ini_set('error_append_string',"</p>");
if(!isset($_SESSION["uid"])){header("location:miniadm.logon.php");}
if(isset($_GET["verbose"])){$GLOBALS["VERBOSE"]=true;}

include_once(dirname(__FILE__)."/ressources/class.templates.inc");
include_once(dirname(__FILE__)."/ressources/class.users.menus.inc");
include_once(dirname(__FILE__)."/ressources/class.miniadm.inc");
include_once(dirname(__FILE__)."/ressources/class.user.inc");
include_once(dirname(__FILE__)."/ressources/class.squid.inc");
include_once(dirname(__FILE__)."/ressources/class.squid.reverse.inc");
$PRIV=GetPrivs();if(!$PRIV){header("location:miniadm.index.php");die();}

if(isset($_GET["unlink-js"])){unlink_js();exit;}
if(isset($_POST["unlink"])){unlink_item();exit;}
if(isset($_GET["search"])){search();exit;}
if(isset($_GET["firewall-js"])){firewall_js();exit;}
if(isset($_GET["firewall-popup"])){firewall_popup();exit;}
if(isset($_POST["firewall"])){firewall_save();exit;}
if(isset($_GET["events"])){events_section();exit;}
if(isset($_GET["events-search"])){events_search();exit;}
section();



function GetPrivs(){
	$NGNIX_PRIVS=$_SESSION["NGNIX_PRIVS"];
	$users=new usersMenus();
	if($users->AsSystemWebMaster){return true;}
	if($users->AsSquidAdministrator){return true;}
	if(count($_SESSION["NGNIX_PRIVS"])>0){return true;}
	return false;

}
function AdminPrivs(){
	$users=new usersMenus();
	if($users->AsSystemWebMaster){return true;}
	if($users->AsSquidAdministrator){return true;}

}

function events_section(){
	$boot=new boostrap_form();
	$tpl=new templates();
	$page=CurrentPageName();
	$error=null;
	
	echo $boot->SearchFormGen("ipaddr","events-search","&servername={$_GET["servername"]}",$EXPLAIN);	
	
}

function section(){
	$boot=new boostrap_form();
	$tpl=new templates();
	$page=CurrentPageName();
	$error=null;
	$EXPLAIN["BUTTONS"][]=$tpl->_ENGINE_parse_body(button("{firewall}", "Loadjs('$page?firewall-js=yes&servername={$_GET["servername"]}')"));
	$EXPLAIN["BUTTONS"][]=$tpl->_ENGINE_parse_body(button("{link_group}", "Loadjs('miniadmin.nginx.exploits.groups.php?servername={$_GET["servername"]}')"));
	echo $tpl->_ENGINE_parse_body("<div class=text-info>{antiexploits_explain}</div>").
	$error.$boot->SearchFormGen("groupname","search","&servername={$_GET["servername"]}",$EXPLAIN);
}

function firewall_js(){
	//https://update.articatech.com:9000/miniadmin.nginx.exploits.php?firewall-js=yes&servername=kavforproxy.org&_=1388241737190
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$title=$tpl->javascript_parse_text("{$_GET["servername"]}::{anti_exploits}::{firewall}");
	echo "YahooWin4(800,'$page?firewall-popup=yes&servername={$_GET["servername"]}','$title')";	
	
}

function unlink_js(){
	header("content-type: application/x-javascript");
	$tpl=new templates();
	$page=CurrentPageName();
	$ID=$_GET["groupid"];
	$q=new mysql_squid_builder();
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_groups WHERE ID='$ID'"));
	$delete=$tpl->javascript_parse_text("{unlink}");
	$zmd5=$_GET["zmd5"];
	$t=time();
	echo "

var xdelete$t= function (obj) {
	var results=obj.responseText;
	if(results.length>3){alert(results);}
	ExecuteByClassName('SearchFunction');
}

function delete$t(){
	if(!confirm('$delete {$ligne["groupname"]} / {$_GET["servername"]}')){return;}
	var XHR = new XHRConnection();
	XHR.appendData('unlink','$zmd5');
	XHR.appendData('servername','{$_GET["servername"]}');
	XHR.sendAndLoad('$page', 'POST',xdelete$t);
}


delete$t();";
}

function unlink_item(){
	$q=new mysql_squid_builder();
	$q->QUERY_SQL("DELETE FROM `nginx_exploits` WHERE `zmd5`='{$_POST["unlink"]}'");
	if(!$q->ok){echo $q->mysql_error;}
}

function search(){
	$prox=new squid_reverse();
	$searchstring=string_to_flexquery("group-search");
	$q=new mysql_squid_builder();
	
	if(!$q->TABLE_EXISTS("nginx_exploits")){
		$sql="CREATE TABLE IF NOT EXISTS `nginx_exploits` (
			  `zmd5` VARCHAR(90) NOT NULL,
			  `groupid` INT  NOT NULL,
			  `servername` CHAR(255)  NOT NULL,
			  PRIMARY KEY (`zmd5`),
			  KEY `servername` (`servername`),
			  KEY `groupid` (`groupid`)
			)  ENGINE = MYISAM;";
		$q->QUERY_SQL($sql);
		if(!$q->ok){senderror($q->mysql_error);}
	}
	
	
	$sql="SELECT * FROM nginx_exploits WHERE servername='{$_GET["servername"]}' LIMIT 0,250";
	$results=$q->QUERY_SQL($sql);
	if(!$q->ok){senderror($q->mysql_error);}
	$tpl=new templates();
	$boot=new boostrap_form();
	$page=CurrentPageName();
	$t=time();

	if($GLOBALS["VERBOSE"]){echo "<H1>$sql</H1><br>". mysql_num_rows($results)." Entries<hr>";}

	while($ligne=mysql_fetch_array($results,MYSQL_ASSOC)){
		$groupid=$ligne["groupid"];
		$icon="www-web-search-64.png";
		$icon2="folder-network-64.png";
		$color="black";
		$md=md5(serialize($ligne));

		
		$delete=imgsimple("delete-64.png",null,"Loadjs('$page?unlink-js=yes&zmd5={$ligne["zmd5"]}&groupid=$groupid&servername={$_GET["servername"]}')");
		$jsedit=$boot->trswitch("Loadjs('miniadmin.nginx.exploits.groups.php?js-group=yes&ID=$groupid&servername={$_GET["servername"]}')");

		$ligne2=mysql_fetch_array($q->QUERY_SQL("SELECT COUNT(*) as tcount FROM nginx_exploits_items WHERE groupid='$groupid'"));
		$RulesNumber=$ligne2["tcount"];

		$ligne2=mysql_fetch_array($q->QUERY_SQL("SELECT groupname FROM nginx_exploits_groups WHERE ID='$groupid'"));
		if(!$q->ok){
			echo $q->mysql_error_html();
		}
		
		$groupname=$ligne2["groupname"];
		
		$tr[]="
		<tr style='color:$color' id='$md'>
		<td width=1% nowrap $jsedit style='vertical-align:middle' nowrap><img src='img/$icon'></td>
		<td width=80% $jsedit style='vertical-align:middle'>
		<span style='font-size:18px;font-weight:bold'>$groupname</span>
		</td>

		<td width=1% nowrap $jsedit style='vertical-align:middle;text-align:center' nowrap>
		<span style='font-size:18px;font-weight:bold'>$RulesNumber</span>
		</td>
		<td width=1% nowrap style='vertical-align:middle;text-align:center'>$delete</td>
		</tr>
		";
	}
	echo $tpl->_ENGINE_parse_body("

			<table class='table table-bordered table-hover'>

			<thead>
				<tr>
					<th colspan=2>{group}</th>
					<th >{items}</th>
					<th>&nbsp;</th>
				</tr>
			</thead>
			 <tbody>").@implode("", $tr)."</tbody></table>
			 <script>
			 var FreeWebIDMEM$t='';
			 var xDelete$t=function (obj) {
			 var results=obj.responseText;
			 if(results.length>10){alert(results);return;}
			 $('#'+FreeWebIDMEM$t).remove();
}

function Delete$t(ID,md){
FreeWebIDMEM$t=md;
if(confirm('Remove '+ID+'?')){
var XHR = new XHRConnection();
XHR.appendData('replace-group-delete',ID);
XHR.sendAndLoad('$page', 'POST',xDelete$t);
}
}</script>
";


}

function firewall_popup(){
	$ID=$_GET["ID"];
	$q=new mysql_squid_builder();
	$bt="{apply}";
	$servername=$_GET["servername"];
	
	if(!$q->TABLE_EXISTS("nginx_exploits_fw")){
		$sql="CREATE TABLE IF NOT EXISTS `nginx_exploits_fw` (
		`servername` CHAR(255) NOT NULL  PRIMARY KEY,
		`maxaccess` smallint(1)  NOT NULL DEFAULT 0,
		`sendlogs` smallint(1)  NOT NULL DEFAULT 0,
		KEY `maxaccess` (`maxaccess`),
		KEY `sendlogs` (`sendlogs`)
		)  ENGINE = MYISAM;";
		if(!$q->QUERY_SQL($sql)){echo $q->mysql_error_html();}
	}
	
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_fw WHERE servername='$servername'"));
	if(!is_numeric($ligne["maxaccess"])){$ligne["maxaccess"]=0;}
	$boot=new boostrap_form();
	$sock=new sockets();
	$boot->set_hidden("servername", $_GET["servername"]);
	$boot->set_hidden("firewall", $_GET["servername"]);
	$boot->set_formtitle("{firewall}");
	$boot->set_formdescription("{NGINX_FW_EXPLAIN}");
	$boot->set_field("maxaccess", "{MAX_EVENTS}", $ligne["maxaccess"],array("TOOLTIP"=>"{NGINX_MAXACCESS_FW_EXPLAIN}"));
	$boot->set_checkbox("sendlogs", "{write_logs}", $ligne["sendlogs"]);
	$boot->set_button($bt);
	if($ID==0){$boot->set_CloseYahoo("YahooWin4");}
	$boot->set_RefreshSearchs();
	echo $boot->Compile();	
}

function firewall_save(){
	$q=new mysql_squid_builder();
	$servername=$_POST["servername"];
	$ligne=mysql_fetch_array($q->QUERY_SQL("SELECT * FROM nginx_exploits_fw WHERE servername='$servername'"));
	if($ligne["servername"]==null){
		$sql="INSERT IGNORE INTO nginx_exploits_fw (servername,maxaccess,sendlogs) VALUES 
				('$servername','{$_POST["maxaccess"]}','{$_POST["sendlogs"]}')";
		if(!$q->QUERY_SQL($sql)){echo $q->mysql_error;}
	}else{
		$sql="UPDATE nginx_exploits_fw 
			SET 
				maxaccess='{$_POST["maxaccess"]}',
				sendlogs='{$_POST["sendlogs"]}'
			WHERE `servername`='$servername'";
		if(!$q->QUERY_SQL($sql)){echo $q->mysql_error;}
	}
}
function events_search(){
	$page=CurrentPageName();
	$boot=new boostrap_form();
	$tpl=new templates();
	$searchstring=string_to_flexquery("events-search");
	$ORDER=$boot->TableOrder(array("zDate"=>"DESC"));
	$limitSql="LIMIT 0,250";
	$sql="SELECT * FROM nginx_exploits_fwev WHERE servername='{$_GET["servername"]}' $searchstring ORDER BY $ORDER $limitSql";
	$q=new mysql_squid_builder();
	$results = $q->QUERY_SQL($sql);
	
	
	
	if(!$q->ok){echo $q->mysql_error_html();}
	
	while ($ligne = mysql_fetch_assoc($results)) {
					$tr[]="
					<tr id='{$ligne["ID"]}'>
					<td width='25%' nowrap><i class='icon-time'></i> {$ligne["zDate"]}</a></td>
					<td width='25%' nowrap>{$ligne["ipaddr"]}</a></td>
					<td width='25%' nowrap>{$ligne["hostname"]}</td>
					<td width='25%' nowrap>{$ligne["country"]}</td>
					</tr>";
	
	
	}
	
	$html=$boot->TableCompile(
			array("zDate"=>"{date}","ipaddr"=>"{ipaddr}","hostname"=>"{hostname}",
					"country"=>"{country}",
	
			),$tr
	);
	
	echo $tpl->_ENGINE_parse_body($html);
}